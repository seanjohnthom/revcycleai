<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PayorMap â€” Claim Routing Intelligence</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  /* Enterprise light palette */
  --bg: #F1F5F9;
  --surface: #FFFFFF;
  --surface2: #F8FAFC;
  --border: #E2E8F0;
  --border-strong: #CBD5E1;
  --accent: #1D4ED8;
  --accent2: #3B82F6;
  --accent-light: #EFF6FF;
  --header-bg: #0D1F37;
  --header-border: #1E3A5F;
  --text: #0F172A;
  --text2: #64748B;
  --text3: #94A3B8;
  --green: #059669; --green-bg: #ECFDF5; --green-border: #A7F3D0;
  --yellow: #D97706; --yellow-bg: #FFFBEB; --yellow-border: #FDE68A;
  --red: #DC2626; --red-bg: #FEF2F2; --red-border: #FECACA;
  --orange: #EA580C;
  --purple: #7C3AED; --purple-bg: #F5F3FF; --purple-border: #DDD6FE;
  --shadow-xs: 0 1px 2px rgba(0,0,0,0.05);
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.04);
  --shadow:    0 4px 6px -1px rgba(0,0,0,0.07), 0 2px 4px -1px rgba(0,0,0,0.04);
  --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.07), 0 4px 6px -2px rgba(0,0,0,0.04);
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { background: var(--bg); color: var(--text); font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; min-height: 100vh; font-size: 14px; }

/* â”€â”€ Header â”€â”€ */
header { background: var(--header-bg); border-bottom: 1px solid var(--header-border); padding: 0 32px; display: flex; align-items: center; justify-content: space-between; height: 60px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
.logo { font-size: 20px; font-weight: 800; letter-spacing: -0.5px; color: #FFFFFF; display: flex; align-items: center; gap: 10px; }
.logo-icon { width: 32px; height: 32px; background: var(--accent); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 16px; }
.logo span { color: #60A5FA; }
.tagline { color: #94A3B8; font-size: 11px; margin-top: 2px; font-weight: 400; letter-spacing: 0.2px; }
.nav-tabs { display: flex; gap: 2px; }
.nav-tab { padding: 7px 16px; border-radius: 7px; font-size: 13px; font-weight: 500; cursor: pointer; border: 1px solid transparent; color: #94A3B8; background: none; transition: all 0.15s; white-space: nowrap; }
.nav-tab:hover { color: #E2E8F0; background: rgba(255,255,255,0.07); }
.nav-tab.active { background: rgba(59,130,246,0.2); border-color: rgba(59,130,246,0.4); color: #93C5FD; font-weight: 600; }
.header-right { display: flex; align-items: center; gap: 12px; }
.phi-pill { background: rgba(5,150,105,0.15); border: 1px solid rgba(5,150,105,0.3); border-radius: 20px; padding: 4px 12px; font-size: 11px; color: #34D399; font-weight: 600; white-space: nowrap; }

/* â”€â”€ PHI Banner â”€â”€ */
.phi-banner { display: none; }

/* â”€â”€ Layout â”€â”€ */
.container { max-width: 1200px; margin: 0 auto; padding: 28px 24px; }
.page { display: none; }
.page.active { display: block; }

/* â”€â”€ Guide Page â”€â”€ */
.guide-hero { text-align: center; padding: 48px 20px 36px; }
.guide-hero h1 { font-size: 34px; font-weight: 800; margin-bottom: 14px; color: var(--text); letter-spacing: -0.5px; }
.guide-hero h1 span { color: var(--accent); }
.guide-hero p { color: var(--text2); font-size: 16px; max-width: 600px; margin: 0 auto; line-height: 1.65; }

.steps { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 32px 0; }
.step { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 24px; position: relative; box-shadow: var(--shadow-sm); transition: box-shadow 0.2s, transform 0.2s; }
.step:hover { box-shadow: var(--shadow); transform: translateY(-2px); }
.step-num { width: 36px; height: 36px; border-radius: 10px; background: var(--accent); display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 15px; margin-bottom: 16px; color: white; }
.step h3 { font-size: 15px; font-weight: 700; margin-bottom: 8px; color: var(--text); }
.step p { font-size: 13px; color: var(--text2); line-height: 1.6; }
.step .examples { margin-top: 12px; display: flex; flex-wrap: wrap; gap: 6px; }
.step .ex-tag { background: var(--accent-light); border: 1px solid #BFDBFE; border-radius: 6px; padding: 3px 10px; font-size: 11px; color: var(--accent); font-weight: 500; }

.scenarios { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 32px; }
.scenario { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.2s; box-shadow: var(--shadow-xs); }
.scenario:hover { border-color: var(--accent); box-shadow: var(--shadow); transform: translateY(-2px); }
.scenario-tag { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; margin-bottom: 8px; }
.scenario-tag.high { color: var(--red); }
.scenario-tag.medium { color: var(--yellow); }
.scenario-tag.low { color: var(--green); }
.scenario h4 { font-size: 14px; font-weight: 700; margin-bottom: 6px; color: var(--text); }
.scenario p { font-size: 12px; color: var(--text2); line-height: 1.5; }
.scenario .arrow { color: var(--accent); font-size: 12px; margin-top: 12px; font-weight: 600; }

.glossary { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 24px; box-shadow: var(--shadow-sm); }
.glossary h3 { font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: var(--text3); margin-bottom: 20px; font-weight: 700; }
.glossary-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
.glossary-item h4 { font-size: 13px; font-weight: 700; margin-bottom: 4px; color: var(--accent); }
.glossary-item p { font-size: 12px; color: var(--text2); line-height: 1.5; }

/* â”€â”€ Query Page â”€â”€ */
.query-layout { display: grid; grid-template-columns: 340px 1fr; gap: 24px; align-items: start; }
.query-card { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 24px; position: sticky; top: 80px; box-shadow: var(--shadow-sm); }
.query-card h2 { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--text3); margin-bottom: 20px; font-weight: 700; }
.field { margin-bottom: 16px; }
label { display: block; font-size: 11px; color: var(--text2); text-transform: uppercase; letter-spacing: 0.8px; font-weight: 600; margin-bottom: 6px; }
.field-hint { font-size: 11px; color: var(--text3); margin-top: 4px; }
input, select { width: 100%; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 9px 12px; color: var(--text); font-size: 14px; outline: none; transition: border-color 0.2s, box-shadow 0.2s; font-family: inherit; }
input:focus, select:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(29,78,216,0.1); background: white; }
input::placeholder { color: var(--text3); }
select { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%2364748B' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 10px center; background-size: 18px; padding-right: 32px; }

.contracts-box { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 8px; min-height: 42px; display: flex; flex-wrap: wrap; gap: 6px; cursor: text; transition: border-color 0.2s, box-shadow 0.2s; }
.contracts-box:focus-within { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(29,78,216,0.1); }
.ctag { background: var(--accent-light); border: 1px solid #BFDBFE; color: var(--accent); padding: 2px 8px; border-radius: 20px; font-size: 12px; display: flex; align-items: center; gap: 5px; font-weight: 500; }
.ctag button { background: none; border: none; color: inherit; cursor: pointer; font-size: 13px; opacity: 0.7; padding: 0; line-height: 1; }
.ctag button:hover { opacity: 1; }
.contracts-box input { background: none; border: none; outline: none; color: var(--text); font-size: 13px; flex: 1; min-width: 100px; padding: 2px 2px; }

.quick-nets { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 6px; }
.qnet { background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; padding: 3px 8px; font-size: 11px; color: var(--text2); cursor: pointer; }
.qnet:hover { border-color: var(--accent); color: var(--accent); }

.btn-run { background: var(--accent); color: white; border: none; border-radius: 8px; padding: 11px; font-size: 14px; font-weight: 600; cursor: pointer; width: 100%; margin-top: 4px; transition: background 0.2s, box-shadow 0.2s; letter-spacing: 0.2px; }
.btn-run:hover { background: #1E40AF; box-shadow: 0 4px 12px rgba(29,78,216,0.3); }
.btn-run:disabled { opacity: 0.4; cursor: not-allowed; }

.quick-payors { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid var(--border); }
.qp-btn { background: var(--surface2); border: 1px solid var(--border); border-radius: 7px; padding: 5px 12px; font-size: 12px; color: var(--text2); cursor: pointer; transition: all 0.15s; }
.qp-btn:hover { border-color: var(--accent); color: var(--text); }

/* â”€â”€ Results Panel â”€â”€ */
.results-panel { min-height: 400px; }
.empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 400px; color: var(--text2); text-align: center; gap: 12px; background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 40px; box-shadow: var(--shadow-sm); }
.empty-state .icon { font-size: 48px; opacity: 0.3; }
.empty-state h3 { font-size: 16px; color: var(--text); font-weight: 600; }
.empty-state p { font-size: 13px; max-width: 300px; line-height: 1.5; }

.result-header { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 22px 26px; margin-bottom: 16px; box-shadow: var(--shadow-sm); }
.result-header-top { display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 12px; margin-bottom: 16px; }
.result-payor-name { font-size: 24px; font-weight: 800; color: var(--text); }
.result-meta { font-size: 12px; color: var(--text2); margin-top: 3px; }
.badges { display: flex; gap: 8px; flex-wrap: wrap; align-items: flex-start; flex-direction: column; }
.badge { padding: 4px 12px; border-radius: 6px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; }
.badge.spp-none,.badge.spp-low { background: var(--green-bg); color: var(--green); border: 1px solid var(--green-border); }
.badge.spp-medium { background: var(--yellow-bg); color: var(--yellow); border: 1px solid var(--yellow-border); }
.badge.spp-high,.badge.spp-very_high { background: var(--red-bg); color: var(--red); border: 1px solid var(--red-border); }

.complexity-row { display: flex; align-items: center; gap: 10px; }
.complexity-label { font-size: 11px; color: var(--text2); text-transform: uppercase; letter-spacing: 0.5px; }
.c-dots { display: flex; gap: 3px; }
.c-dot { width: 10px; height: 10px; border-radius: 2px; background: var(--border); }
.c-dot.on-low { background: var(--green); }
.c-dot.on-mid { background: var(--yellow); }
.c-dot.on-high { background: var(--red); }

.recommendation { background: var(--accent-light); border: 1px solid #BFDBFE; border-radius: 10px; padding: 13px 16px; font-size: 13px; line-height: 1.6; margin-bottom: 16px; color: #1E3A8A; }

.global-alerts { display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px; }
.alert-banner { background: var(--red-bg); border: 1px solid var(--red-border); border-radius: 8px; padding: 10px 14px; font-size: 13px; color: var(--red); }

/* â”€â”€ Visual Matrix â”€â”€ */
.matrix-section { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 22px 26px; margin-bottom: 16px; box-shadow: var(--shadow-sm); }
.section-title { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--text3); font-weight: 700; margin-bottom: 18px; }
.prob-matrix { width: 100%; border-collapse: collapse; font-size: 12px; }
.prob-matrix th { text-align: left; padding: 8px 10px; color: var(--text2); font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid var(--border); background: var(--surface2); font-weight: 600; }
.prob-matrix td { padding: 11px 10px; border-bottom: 1px solid var(--border); vertical-align: middle; }
.prob-matrix tr:last-child td { border-bottom: none; }
.prob-matrix tr:hover td { background: var(--accent-light); }
.rank-badge { width: 24px; height: 24px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 800; flex-shrink: 0; }
.rank-badge.r1 { background: var(--accent); color: white; }
.rank-badge.r2 { background: var(--accent-light); color: var(--accent); }
.rank-badge.rn { background: var(--surface2); color: var(--text3); }
.bar-cell { display: flex; align-items: center; gap: 10px; }
.bar-wrap { flex: 1; height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; min-width: 80px; }
.bar-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }
.bar-fill.high { background: linear-gradient(90deg, #059669, #10B981); }
.bar-fill.medium { background: linear-gradient(90deg, #D97706, #F59E0B); }
.bar-fill.low { background: #CBD5E1; }
.pct-label { font-size: 14px; font-weight: 700; min-width: 38px; text-align: right; }
.pct-label.high { color: var(--green); }
.pct-label.medium { color: var(--yellow); }
.pct-label.low { color: var(--text3); }
.path-type-chip { padding: 2px 8px; border-radius: 5px; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; white-space: nowrap; }
.path-type-chip.direct { background: var(--green-bg); color: var(--green); border: 1px solid var(--green-border); }
.path-type-chip.leased { background: var(--purple-bg); color: var(--purple); border: 1px solid var(--purple-border); }
.alert-chips { display: flex; gap: 4px; flex-wrap: wrap; }
.alert-chip { padding: 2px 7px; border-radius: 5px; font-size: 10px; font-weight: 600; }
.alert-chip.spp { background: var(--red-bg); color: var(--red); border: 1px solid var(--red-border); }
.alert-chip.override { background: var(--yellow-bg); color: var(--yellow); border: 1px solid var(--yellow-border); }

/* â”€â”€ Detail Cards â”€â”€ */
.detail-cards { display: flex; flex-direction: column; gap: 12px; margin-bottom: 16px; }
.detail-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 18px 20px; box-shadow: var(--shadow-xs); }
.detail-card.top-pick { border-color: #93C5FD; border-left: 3px solid var(--accent); }
.dc-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; flex-wrap: wrap; gap: 8px; }
.dc-title { font-size: 15px; font-weight: 700; color: var(--text); }
.dc-chips { display: flex; gap: 6px; flex-wrap: wrap; align-items: center; }
.dc-notes { font-size: 13px; color: var(--text2); line-height: 1.5; margin-bottom: 10px; }
.dc-alerts { display: flex; flex-direction: column; gap: 5px; }
.dc-alert { font-size: 12px; padding: 6px 10px; border-radius: 6px; background: var(--surface2); border: 1px solid var(--border); }
.dc-alert.warn { border-color: var(--red-border); background: var(--red-bg); color: #991B1B; }
.dc-alert.ok { border-color: var(--green-border); background: var(--green-bg); color: #065F46; }

/* â”€â”€ Rules â”€â”€ */
.rules-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 18px 22px; box-shadow: var(--shadow-xs); }
.rules-list { display: flex; flex-direction: column; gap: 8px; }
.rule-row { font-size: 13px; color: var(--text); line-height: 1.5; padding-left: 18px; position: relative; }
.rule-row::before { content: 'â†’'; position: absolute; left: 0; color: var(--accent); font-weight: 700; }

/* â”€â”€ Network Map â”€â”€ */
.network-map-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 16px; }
.network-card { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 20px; box-shadow: var(--shadow-xs); }
.network-card h3 { font-size: 15px; font-weight: 700; margin-bottom: 4px; color: var(--text); }
.network-card .parent { font-size: 11px; color: var(--text2); margin-bottom: 14px; }
.network-card .stat { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid var(--border); font-size: 12px; }
.network-card .stat:last-child { border-bottom: none; }
.network-card .stat-label { color: var(--text2); }
.network-card .stat-value { font-weight: 600; color: var(--text); }
.network-aka { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 12px; }
.aka-tag { background: var(--surface2); border: 1px solid var(--border); border-radius: 4px; padding: 2px 7px; font-size: 10px; color: var(--text2); }

.loading-spinner { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px; gap: 14px; color: var(--text2); }
.spinner { width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.7s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* â”€â”€ Page section headers â”€â”€ */
.page-header { margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--border); }
.page-header h2 { font-size: 20px; font-weight: 700; color: var(--text); }
.page-header p { font-size: 13px; color: var(--text2); margin-top: 4px; }
</style>
</head>
<body>

<header>
  <div style="display:flex;align-items:center;gap:14px">
    <div class="logo-icon">ğŸ—ºï¸</div>
    <div>
      <div class="logo">Payor<span>Map</span></div>
      <div class="tagline">PPO Leased Network Intelligence</div>
    </div>
  </div>
  <div class="nav-tabs">
    <button class="nav-tab active" onclick="showPage('guide')">How It Works</button>
    <button class="nav-tab" onclick="showPage('query')">Routing Query</button>
    <button class="nav-tab" onclick="showPage('map')">US Coverage Map</button>
    <button class="nav-tab" onclick="showPage('cdt')">CDT Allowables</button>
    <button class="nav-tab" onclick="showPage('ucr')">UCR Benchmarking</button>
    <button class="nav-tab" onclick="showPage('alerts')">Alerts & News</button>
    <button class="nav-tab" onclick="showPage('networks')">Networks</button>
  </div>
  <div class="header-right">
    <div class="phi-pill">âœ“ PHI-Free</div>
  </div>
</header>

<div class="phi-banner">
  ğŸ”’ <strong>PHI-FREE BY DESIGN</strong> â€” Never requires patient name, member ID, date of birth, or any identifying information. Payor + plan type only.
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  PAGE 1: HOW IT WORKS                     -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="container page active" id="page-guide">
  <div class="guide-hero">
    <h1>Stop Guessing <span>Which Network Pays</span></h1>
    <p>When a patient walks in, you may not know which of your umbrella network contracts will reprice their claim â€” or if a silent PPO is about to undercut your fee schedule. PayorMap gives you the answer in seconds.</p>
  </div>

  <div class="steps">
    <div class="step">
      <div class="step-num">1</div>
      <h3>Enter the Payor</h3>
      <p>Type the insurance company name on the patient's card. You can use any common name or abbreviation.</p>
      <div class="examples">
        <span class="ex-tag">MetLife</span><span class="ex-tag">UHC</span><span class="ex-tag">Cigna</span><span class="ex-tag">Humana</span><span class="ex-tag">Anthem</span>
      </div>
    </div>
    <div class="step">
      <div class="step-num">2</div>
      <h3>Add Plan Type (Optional but Powerful)</h3>
      <p>The plan type on the insurance card dramatically narrows the routing. With MetLife, "PDP Plus" vs "PDP" routes completely differently.</p>
      <div class="examples">
        <span class="ex-tag">PDP Plus</span><span class="ex-tag">DPPO</span><span class="ex-tag">FEDVIP</span><span class="ex-tag">Loyalty Plus</span>
      </div>
    </div>
    <div class="step">
      <div class="step-num">3</div>
      <h3>Add Your Contracts</h3>
      <p>Enter the networks and payors your practice is contracted with. The routing engine adjusts probabilities based on what you actually have.</p>
      <div class="examples">
        <span class="ex-tag">Careington</span><span class="ex-tag">DenteMax</span><span class="ex-tag">Zelis</span><span class="ex-tag">Direct MetLife</span>
      </div>
    </div>
  </div>

  <h2 style="font-size:13px;text-transform:uppercase;letter-spacing:1px;color:var(--text2);margin-bottom:16px;font-weight:700">âš¡ Common Scenarios â€” Click to Run</h2>
  <div class="scenarios">
    <div class="scenario" onclick="loadScenario('metlife-pdpplus')">
      <div class="scenario-tag high">ğŸ”´ High Confusion</div>
      <h4>MetLife PDP Plus patient â€” do you need a direct contract?</h4>
      <p>One of the most common mistakes. Careington covers PDP Plus but NOT standard PDP. Get it wrong and you're billing out-of-network.</p>
      <div class="arrow">Run this scenario â†’</div>
    </div>
    <div class="scenario" onclick="loadScenario('uhc-silent')">
      <div class="scenario-tag high">ğŸ”´ Silent PPO Risk</div>
      <h4>UHC claim â€” is Careington repricing without telling you?</h4>
      <p>UHC is one of the most frequent silent PPO offenders. Your direct UHC rate may be getting overridden by a Careington lease you didn't know applied.</p>
      <div class="arrow">Run this scenario â†’</div>
    </div>
    <div class="scenario" onclick="loadScenario('humana-zelis')">
      <div class="scenario-tag medium">ğŸŸ¡ Leasing Complexity</div>
      <h4>Humana â€” direct contract or Zelis reprice?</h4>
      <p>Humana leases heavily through Zelis/Maverest. Many practices assume direct when they're actually getting repriced at Zelis rates.</p>
      <div class="arrow">Run this scenario â†’</div>
    </div>
    <div class="scenario" onclick="loadScenario('beam-dentemax')">
      <div class="scenario-tag low">ğŸŸ¢ Simple Routing</div>
      <h4>Beam Dental â€” which network do you actually need?</h4>
      <p>Beam operates almost entirely through DenteMax. If you don't have DenteMax, you're out-of-network for Beam â€” period.</p>
      <div class="arrow">Run this scenario â†’</div>
    </div>
  </div>

  <div class="glossary">
    <h3>Key Terms</h3>
    <div class="glossary-grid">
      <div class="glossary-item">
        <h4>Umbrella Network / Leasing Network</h4>
        <p>A company (like Careington or DenteMax) that contracts with dental practices and then "leases" access to insurance payors. One contract = access to many payors.</p>
      </div>
      <div class="glossary-item">
        <h4>Silent PPO</h4>
        <p>When a payor reprices your claim at a discounted network rate without your knowledge, using a leased network access you didn't realize applied. Shows up on the EOB â€” after the fact.</p>
      </div>
      <div class="glossary-item">
        <h4>Network Stacking</h4>
        <p>When multiple umbrella networks can access the same payor, each at potentially different fee schedules. The payor picks the lowest â€” which may not be your direct contract rate.</p>
      </div>
      <div class="glossary-item">
        <h4>Override Risk</h4>
        <p>The risk that a leased network rate overrides your higher direct contract rate. Some umbrella contracts contain clauses allowing this â€” costing you revenue on every claim.</p>
      </div>
      <div class="glossary-item">
        <h4>Routing Probability</h4>
        <p>The likelihood that a specific network path will be used to reprice a claim, based on plan type, your contracts, and known payor behavior.</p>
      </div>
      <div class="glossary-item">
        <h4>Confusion Score</h4>
        <p>PayorMap's 1â€“10 rating of how complex a payor's network routing is. MetLife scores 10/10 due to the PDP vs PDP Plus distinction. Beam scores 2/10 â€” it's almost always DenteMax.</p>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  PAGE 2: ROUTING QUERY                    -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="container page" id="page-query">
  <div class="query-layout">

    <!-- Left: Query Form -->
    <div class="query-card">
      <h2>Claim Routing Query</h2>

      <div class="quick-payors">
        <div style="font-size:11px;color:var(--text2);width:100%;margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px">Quick Select</div>
        <button class="qp-btn" onclick="quickPayor('MetLife')">MetLife</button>
        <button class="qp-btn" onclick="quickPayor('Cigna')">Cigna</button>
        <button class="qp-btn" onclick="quickPayor('UHC')">UHC</button>
        <button class="qp-btn" onclick="quickPayor('Humana')">Humana</button>
        <button class="qp-btn" onclick="quickPayor('Delta Dental')">Delta</button>
        <button class="qp-btn" onclick="quickPayor('Aetna')">Aetna</button>
        <button class="qp-btn" onclick="quickPayor('Guardian')">Guardian</button>
        <button class="qp-btn" onclick="quickPayor('Anthem')">Anthem</button>
        <button class="qp-btn" onclick="quickPayor('Beam Dental')">Beam</button>
      </div>

      <div class="field">
        <label>Payor / Insurance Company *</label>
        <input id="payorInput" type="text" placeholder="e.g. MetLife, UHC, Cigna..." autocomplete="off">
      </div>

      <div class="field">
        <label>Plan Type <span style="text-transform:none;font-weight:400;color:var(--text2)">(optional â€” improves accuracy)</span></label>
        <input id="planTypeInput" type="text" placeholder="e.g. PDP Plus, DPPO, FEDVIP, Loyalty Plus...">
        <div class="field-hint">Found on the patient's insurance card or EOB</div>
      </div>

      <div class="field">
        <label>State <span style="text-transform:none;font-weight:400;color:var(--text2)">(optional)</span></label>
        <select id="stateInput">
          <option value="">All States</option>
          <option>AL</option><option>AK</option><option>AZ</option><option>AR</option><option>CA</option>
          <option>CO</option><option>CT</option><option>DE</option><option>FL</option><option>GA</option>
          <option>HI</option><option>ID</option><option>IL</option><option>IN</option><option>IA</option>
          <option>KS</option><option>KY</option><option>LA</option><option>ME</option><option>MD</option>
          <option>MA</option><option>MI</option><option>MN</option><option>MS</option><option>MO</option>
          <option>MT</option><option>NE</option><option>NV</option><option>NH</option><option>NJ</option>
          <option>NM</option><option>NY</option><option>NC</option><option>ND</option><option>OH</option>
          <option>OK</option><option>OR</option><option>PA</option><option>RI</option><option>SC</option>
          <option>SD</option><option>TN</option><option>TX</option><option>UT</option><option>VT</option>
          <option>VA</option><option>WA</option><option>WV</option><option>WI</option><option>WY</option>
        </select>
        <div class="field-hint">Required for BCBS routing (state-specific)</div>
      </div>

      <div class="field">
        <label>Your Practice's Contracts <span style="text-transform:none;font-weight:400;color:var(--text2)">(optional)</span></label>
        <div class="contracts-box" id="contractsBox" onclick="document.getElementById('cInput').focus()">
          <input id="cInput" type="text" placeholder="Type + Enter to add...">
        </div>
        <div class="quick-nets">
          <span style="font-size:10px;color:var(--text2);width:100%">Common networks:</span>
          <button class="qnet" onclick="addContract('Careington')">Careington</button>
          <button class="qnet" onclick="addContract('DenteMax')">DenteMax</button>
          <button class="qnet" onclick="addContract('Zelis')">Zelis</button>
          <button class="qnet" onclick="addContract('Connection Dental')">Connection Dental</button>
          <button class="qnet" onclick="addContract('DNOA')">DNOA</button>
        </div>
        <div class="field-hint">Knowing your contracts makes routing predictions significantly more accurate</div>
      </div>

      <button class="btn-run" id="runBtn" onclick="runQuery()">Analyze Routing â†’</button>
    </div>

    <!-- Right: Results -->
    <div class="results-panel" id="resultsPanel">
      <div class="empty-state" id="emptyState">
        <div class="icon">ğŸ¦·</div>
        <h3>Ready to Route</h3>
        <p>Enter a payor on the left to see the full claim routing probability matrix.</p>
        <p style="margin-top:8px;font-size:12px;opacity:0.6">Try the <strong>How It Works</strong> tab for guided examples</p>
      </div>
      <div id="resultContent" style="display:none"></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  PAGE 3: US MAP                           -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="container page" id="page-map">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:12px">
    <div>
      <h2 style="font-size:20px;font-weight:800">US Network Coverage Map</h2>
      <p style="font-size:13px;color:var(--text2);margin-top:4px">Select a payor to see state-by-state routing risk and network path</p>
    </div>
    <select id="mapPayorSelect" onchange="updateMap()" style="width:220px">
      <option value="">Select a payor...</option>
      <option value="anthem_bcbs">Anthem / BCBS</option>
      <option value="cigna">Cigna</option>
      <option value="uhc">UnitedHealthcare</option>
      <option value="humana">Humana</option>
      <option value="metlife">MetLife</option>
      <option value="aetna">Aetna</option>
    </select>
  </div>
  <div style="display:grid;grid-template-columns:1fr 280px;gap:20px;align-items:start">
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:24px">
      <svg id="usSvg" viewBox="0 0 960 600" style="width:100%;height:auto"></svg>
      <div style="display:flex;gap:20px;margin-top:16px;flex-wrap:wrap">
        <div style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text2)"><div style="width:14px;height:14px;border-radius:3px;background:#27ae60"></div> Direct â€” Low Risk</div>
        <div style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text2)"><div style="width:14px;height:14px;border-radius:3px;background:#f39c12"></div> Leased â€” Medium Risk</div>
        <div style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text2)"><div style="width:14px;height:14px;border-radius:3px;background:#e74c3c"></div> High Silent PPO Risk</div>
        <div style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text2)"><div style="width:14px;height:14px;border-radius:3px;background:#7c5cbf"></div> DNOA Routing (BCBS)</div>
        <div style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text2)"><div style="width:14px;height:14px;border-radius:3px;background:var(--border)"></div> No special routing</div>
      </div>
    </div>
    <div id="mapStateDetail" style="background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:20px">
      <div style="color:var(--text2);font-size:13px;text-align:center;padding:40px 0">
        <div style="font-size:32px;margin-bottom:8px">ğŸ—ºï¸</div>
        Select a payor above, then hover a state for details
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  PAGE 4: CDT ALLOWABLES                   -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="container page" id="page-cdt">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:12px">
    <div>
      <h2 style="font-size:20px;font-weight:800">CDT Code Fee Allowables</h2>
      <p style="font-size:13px;color:var(--text2);margin-top:4px">Typical fee ranges by CDT code Â· Sourced from public Medicaid, TRICARE & VA schedules</p>
    </div>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <input id="cdtSearch" type="text" placeholder="Search code or description..." style="width:220px" oninput="searchCDT()">
      <select id="cdtCategory" onchange="searchCDT()" style="width:160px">
        <option value="">All Categories</option>
        <option>Diagnostic</option><option>Preventive</option><option>Restorative</option>
        <option>Endodontics</option><option>Periodontics</option><option>Oral Surgery</option>
        <option>Prosthodontics</option><option>Implants</option><option>Orthodontics</option>
        <option>Adjunctive</option>
      </select>
    </div>
  </div>
  <div id="cdtTableWrap">
    <div class="loading-spinner"><div class="spinner"></div><span>Loading fee data...</span></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  PAGE 5: UCR BENCHMARKING                 -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="container page" id="page-ucr">
  <div class="page-header">
    <h2>UCR Fee Schedule Benchmarking</h2>
    <p>Upload your current fee schedule, benchmark every CDT code against market data, identify revenue opportunities, and export a recommended new schedule.</p>
  </div>

  <div style="display:grid;grid-template-columns:380px 1fr;gap:24px;align-items:start">
    <!-- Left Panel: Upload & Settings -->
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:24px;position:sticky;top:80px;box-shadow:var(--shadow-sm)">
      <h3 style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--text3);margin-bottom:20px;font-weight:700">â¬†ï¸ Upload Fee Schedule</h3>
      
      <div class="field">
        <label>CSV Format</label>
        <div style="font-size:11px;color:var(--text3);margin-bottom:10px;line-height:1.4">
          Required columns: <code style="background:var(--surface2);padding:2px 6px;border-radius:4px;font-size:10px">code</code>, <code style="background:var(--surface2);padding:2px 6px;border-radius:4px;font-size:10px">ucr</code><br>
          Optional: <code style="background:var(--surface2);padding:2px 6px;border-radius:4px;font-size:10px">volume</code> (annual procedure count)
        </div>
        <input type="file" id="ucrFileInput" accept=".csv" style="font-size:13px">
      </div>

      <div class="field">
        <label>Target Percentile</label>
        <select id="ucrTarget">
          <option value="75">75th Percentile (Conservative)</option>
          <option value="80" selected>80th Percentile (Market Rate)</option>
          <option value="90">90th Percentile (Aggressive)</option>
        </select>
        <div class="field-hint">Industry standard: 80th percentile</div>
      </div>

      <button class="btn-run" onclick="analyzeUCR()">
        <span id="ucrBtnText">ğŸ“Š Analyze Fee Schedule</span>
      </button>

      <div style="margin-top:20px;padding-top:20px;border-top:1px solid var(--border)">
        <h4 style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--text3);margin-bottom:12px;font-weight:700">Or Try Sample Data</h4>
        <button onclick="loadSampleUCR()" style="background:var(--surface2);border:1px solid var(--border);border-radius:7px;padding:8px 14px;font-size:13px;color:var(--text);cursor:pointer;width:100%;transition:all 0.15s">
          Load Sample Fee Schedule
        </button>
      </div>
    </div>

    <!-- Right Panel: Results -->
    <div id="ucrResults">
      <div class="empty-state">
        <div class="icon">ğŸ“ˆ</div>
        <h3>Ready to Benchmark Your UCR</h3>
        <p>Upload your current fee schedule or load sample data to see where every CDT code sits relative to market benchmarks.</p>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  PAGE 6: ALERTS & NEWS                    -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="container page" id="page-alerts">
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;align-items:start">
    <div>
      <h2 style="font-size:16px;font-weight:800;margin-bottom:16px">ğŸ”” Network Change Alerts</h2>
      <div id="alertsList"><div class="loading-spinner"><div class="spinner"></div><span>Loading...</span></div></div>
    </div>
    <div>
      <h2 style="font-size:16px;font-weight:800;margin-bottom:16px">ğŸ“° Dental Industry News</h2>
      <div id="newsList"><div class="loading-spinner"><div class="spinner"></div><span>Loading...</span></div></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  PAGE 7: NETWORK DIRECTORY                -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="container page" id="page-networks">
  <h2 style="font-size:13px;text-transform:uppercase;letter-spacing:1px;color:var(--text2);margin-bottom:20px;font-weight:700">Umbrella Network Directory</h2>
  <div class="network-map-grid" id="networkGrid">
    <div class="loading-spinner"><div class="spinner"></div><span>Loading networks...</span></div>
  </div>
</div>

<script>
const contracts = [];

// â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showPage(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('page-' + id).classList.add('active');
  event.target.classList.add('active');
  if (id === 'networks') loadNetworks();
}

// â”€â”€ Contract tags â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('cInput').addEventListener('keydown', e => {
  if ((e.key === 'Enter' || e.key === ',') && e.target.value.trim()) {
    e.preventDefault();
    addContract(e.target.value.trim());
    e.target.value = '';
  } else if (e.key === 'Backspace' && !e.target.value && contracts.length) {
    contracts.pop(); renderTags();
  }
});

function addContract(name) {
  if (!contracts.includes(name)) { contracts.push(name); renderTags(); }
}

function renderTags() {
  document.querySelectorAll('.ctag').forEach(t => t.remove());
  const box = document.getElementById('contractsBox');
  const input = document.getElementById('cInput');
  contracts.forEach((c, i) => {
    const t = document.createElement('span');
    t.className = 'ctag';
    t.innerHTML = `${c}<button onclick="contracts.splice(${i},1);renderTags()">Ã—</button>`;
    box.insertBefore(t, input);
  });
}

// â”€â”€ Quick payor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function quickPayor(name) {
  document.getElementById('payorInput').value = name;
  runQuery();
}

// â”€â”€ Scenarios â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SCENARIOS = {
  'metlife-pdpplus': { payor:'MetLife', plan_type:'PDP Plus', contracts:['Careington','Delta Dental'] },
  'uhc-silent':      { payor:'UnitedHealthcare', plan_type:'PPO', contracts:['Careington','Delta Dental','DenteMax'] },
  'humana-zelis':    { payor:'Humana', plan_type:'PPO', contracts:['Zelis','Careington'] },
  'beam-dentemax':   { payor:'Beam Dental', plan_type:'PPO', contracts:['DenteMax'] },
};

function loadScenario(id) {
  const s = SCENARIOS[id];
  if (!s) return;
  document.getElementById('payorInput').value = s.payor;
  document.getElementById('planTypeInput').value = s.plan_type || '';
  contracts.length = 0;
  (s.contracts || []).forEach(c => contracts.push(c));
  renderTags();
  showPage('query');
  document.querySelectorAll('.nav-tab')[1].classList.add('active');
  document.querySelectorAll('.nav-tab')[0].classList.remove('active');
  setTimeout(runQuery, 100);
}

// â”€â”€ Run query â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function runQuery() {
  const payor = document.getElementById('payorInput').value.trim();
  if (!payor) { alert('Please enter a payor name'); return; }

  document.getElementById('emptyState').style.display = 'none';
  document.getElementById('resultContent').style.display = 'block';
  document.getElementById('resultContent').innerHTML = '<div class="loading-spinner"><div class="spinner"></div><span>Analyzing routing paths...</span></div>';
  document.getElementById('runBtn').disabled = true;

  try {
    const res = await fetch('/api/route', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        payor,
        plan_type: document.getElementById('planTypeInput').value.trim() || null,
        practice_contracts: [...contracts],
        state: document.getElementById('stateInput').value || null,
      }),
    });
    const data = await res.json();
    renderResults(data);
  } catch(e) {
    document.getElementById('resultContent').innerHTML = `<div class="recommendation" style="color:var(--red)">Error: ${e.message}</div>`;
  } finally {
    document.getElementById('runBtn').disabled = false;
  }
}

// â”€â”€ Render results â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderResults(d) {
  if (d.error) {
    document.getElementById('resultContent').innerHTML = `<div class="recommendation" style="color:var(--red)">âš ï¸ ${d.error}</div>`;
    return;
  }

  const sppLabels = { none:'No Silent PPO Risk', low:'Low Silent PPO Risk', medium:'Medium Silent PPO Risk', high:'âš ï¸ High Silent PPO Risk', very_high:'ğŸš¨ Very High Silent PPO Risk' };
  const sppClass = `spp-${d.silent_ppo_risk}`;

  // Confusion dots
  const dots = Array.from({length:10}, (_,i) => {
    let cls = '';
    if (i < d.confusion_score) cls = i < 4 ? 'on-low' : i < 7 ? 'on-mid' : 'on-high';
    return `<div class="c-dot ${cls}"></div>`;
  }).join('');

  let html = `
    <div class="result-header">
      <div class="result-header-top">
        <div>
          <div class="result-payor-name">${d.payor}</div>
          <div class="result-meta">Plan: ${d.plan_type_queried} Â· State: ${d.state}${d.practice_contracts_provided ? ' Â· Contract data applied' : ''}</div>
        </div>
        <div class="badges">
          <span class="badge ${sppClass}">${sppLabels[d.silent_ppo_risk] || d.silent_ppo_risk}</span>
        </div>
      </div>
      <div class="complexity-row">
        <span class="complexity-label">Routing complexity</span>
        <div class="c-dots">${dots}</div>
        <span class="complexity-label">${d.confusion_score}/10</span>
      </div>
    </div>`;

  if (d.global_alerts?.length) {
    html += `<div class="global-alerts">${d.global_alerts.map(a => `<div class="alert-banner">${a}</div>`).join('')}</div>`;
  }

  html += `<div class="recommendation"><strong>ğŸ“‹ Analysis:</strong> ${d.recommendation}</div>`;

  // â”€â”€ Visual probability matrix â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  html += `
    <div class="matrix-section">
      <div class="section-title">Routing Probability Matrix</div>
      <table class="prob-matrix">
        <thead>
          <tr>
            <th style="width:32px"></th>
            <th>Network Path</th>
            <th style="width:180px">Probability</th>
            <th>Type</th>
            <th>Flags</th>
          </tr>
        </thead>
        <tbody>`;

  d.routes.forEach((r, i) => {
    const pct = Math.round(r.probability * 100);
    const conf = r.confidence;
    const rankClass = i === 0 ? 'r1' : i === 1 ? 'r2' : 'rn';
    const chips = [];
    if (r.silent_ppo_risk) chips.push(`<span class="alert-chip spp">Silent PPO</span>`);
    if (r.override_risk === 'high' || r.override_risk === 'medium') chips.push(`<span class="alert-chip override">Override ${r.override_risk}</span>`);

    html += `
      <tr>
        <td><div class="rank-badge ${rankClass}">${i+1}</div></td>
        <td style="font-size:13px;font-weight:${i===0?700:400}">${r.label}</td>
        <td>
          <div class="bar-cell">
            <div class="bar-wrap"><div class="bar-fill ${conf}" style="width:${pct}%"></div></div>
            <span class="pct-label ${conf}">${pct}%</span>
          </div>
        </td>
        <td><span class="path-type-chip ${r.type}">${r.type === 'direct' ? 'âœ“ Direct' : 'âŸ³ Leased'}</span>${r.umbrella_network ? `<br><span style="font-size:10px;color:var(--text2);margin-top:2px;display:block">via ${r.umbrella_network}</span>` : ''}</td>
        <td><div class="alert-chips">${chips.join('') || '<span style="font-size:11px;color:var(--text2)">â€”</span>'}</div></td>
      </tr>`;
  });

  html += `</tbody></table></div>`;

  // â”€â”€ Detail cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  html += `<div class="section-title" style="margin-bottom:12px">Path Details</div><div class="detail-cards">`;
  d.routes.forEach((r, i) => {
    const alertsHtml = r.alerts.map(a => {
      const isWarn = a.includes('âš ï¸') || a.includes('ğŸ”´') || a.includes('RISK') || a.includes('SILENT');
      const isOk = a.includes('âœ“');
      return `<div class="dc-alert ${isWarn ? 'warn' : isOk ? 'ok' : ''}">${a}</div>`;
    }).join('');

    html += `
      <div class="detail-card ${i===0 ? 'top-pick' : ''}">
        <div class="dc-header">
          <div class="dc-title">#${i+1} â€” ${r.label}</div>
          <div class="dc-chips">
            <span class="path-type-chip ${r.type}">${r.type === 'direct' ? 'âœ“ Direct' : 'âŸ³ Leased'}</span>
            ${r.umbrella_network ? `<span class="path-type-chip leased">via ${r.umbrella_network}</span>` : ''}
          </div>
        </div>
        <div class="dc-notes">${r.notes}</div>
        ${alertsHtml ? `<div class="dc-alerts">${alertsHtml}</div>` : ''}
      </div>`;
  });
  html += `</div>`;

  // â”€â”€ Routing rules â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (d.routing_rules?.length) {
    html += `
      <div class="rules-card">
        <div class="section-title" style="margin-bottom:14px">Routing Rules for ${d.payor}</div>
        <div class="rules-list">
          ${d.routing_rules.map(r => `<div class="rule-row">${r}</div>`).join('')}
        </div>
      </div>`;
  }

  document.getElementById('resultContent').innerHTML = html;
}

// â”€â”€ Network Map â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadNetworks() {
  const grid = document.getElementById('networkGrid');
  try {
    const res = await fetch('/api/networks');
    const networks = await res.json();
    grid.innerHTML = networks.map(n => `
      <div class="network-card">
        <h3>${n.name}</h3>
        <div class="parent">${n.parent}</div>
        <div class="stat"><span class="stat-label">Type</span><span class="stat-value">${n.type.replace(/_/g,' ')}</span></div>
        ${n.estimated_providers ? `<div class="stat"><span class="stat-label">Providers</span><span class="stat-value">${n.estimated_providers.toLocaleString()}+</span></div>` : ''}
        ${n.notes ? `<div style="font-size:12px;color:var(--text2);margin-top:12px;line-height:1.5">${n.notes}</div>` : ''}
        ${n.key_exclusions?.length ? `<div style="margin-top:12px"><div style="font-size:10px;text-transform:uppercase;letter-spacing:0.5px;color:var(--red);margin-bottom:6px">Key Exclusions</div>${n.key_exclusions.map(e => `<div style="font-size:11px;color:var(--text2);padding:3px 0;border-bottom:1px solid var(--border)">âš ï¸ ${e}</div>`).join('')}</div>` : ''}
        ${n.aka?.length ? `<div class="network-aka">${n.aka.slice(0,4).map(a => `<span class="aka-tag">${a}</span>`).join('')}${n.aka.length > 4 ? `<span class="aka-tag">+${n.aka.length-4} more</span>` : ''}</div>` : ''}
      </div>`).join('');
  } catch(e) {
    grid.innerHTML = `<div style="color:var(--red)">Failed to load networks: ${e.message}</div>`;
  }
}

// Enter key
document.getElementById('payorInput').addEventListener('keydown', e => { if(e.key==='Enter') runQuery(); });

// â”€â”€ Page loader â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const _origShowPage = showPage;
window.showPage = function(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('page-' + id).classList.add('active');
  event.target.classList.add('active');
  if (id === 'networks') loadNetworks();
  if (id === 'map')      initMap();
  if (id === 'cdt')      loadCDT();
  if (id === 'alerts')   loadAlerts();
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// US MAP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STATE_PATHS = {
  AL:'M 583 370 L 600 370 L 605 430 L 583 430 Z',AK:'M 110 480 L 200 480 L 200 560 L 110 560 Z',
  AZ:'M 155 320 L 230 320 L 230 400 L 155 400 Z',AR:'M 530 350 L 580 350 L 580 390 L 530 390 Z',
  CA:'M 90 220 L 160 220 L 160 360 L 90 380 Z',CO:'M 250 280 L 340 280 L 340 330 L 250 330 Z',
  CT:'M 760 220 L 780 220 L 780 240 L 760 240 Z',DE:'M 740 250 L 755 250 L 755 270 L 740 270 Z',
  FL:'M 590 420 L 660 420 L 670 480 L 620 500 L 590 460 Z',GA:'M 600 380 L 650 380 L 650 430 L 600 430 Z',
  HI:'M 240 530 L 330 530 L 330 570 L 240 570 Z',ID:'M 175 160 L 235 160 L 235 260 L 175 260 Z',
  IL:'M 545 270 L 580 270 L 580 350 L 545 350 Z',IN:'M 575 265 L 605 265 L 605 330 L 575 330 Z',
  IA:'M 480 235 L 545 235 L 545 280 L 480 280 Z',KS:'M 370 305 L 470 305 L 470 345 L 370 345 Z',
  KY:'M 575 310 L 660 310 L 660 345 L 575 345 Z',LA:'M 505 410 L 565 410 L 565 450 L 505 450 Z',
  ME:'M 800 150 L 830 150 L 830 200 L 800 200 Z',MD:'M 710 265 L 750 265 L 750 285 L 710 285 Z',
  MA:'M 770 205 L 815 205 L 815 225 L 770 225 Z',MI:'M 570 190 L 630 190 L 630 240 L 570 240 Z',
  MN:'M 460 155 L 535 155 L 535 235 L 460 235 Z',MS:'M 545 370 L 585 370 L 585 430 L 545 430 Z',
  MO:'M 490 295 L 555 295 L 555 355 L 490 355 Z',MT:'M 215 145 L 340 145 L 340 215 L 215 215 Z',
  NE:'M 370 255 L 470 255 L 470 305 L 370 305 Z',NV:'M 140 220 L 200 220 L 200 320 L 140 320 Z',
  NH:'M 790 175 L 810 175 L 810 215 L 790 215 Z',NJ:'M 740 235 L 760 235 L 760 265 L 740 265 Z',
  NM:'M 230 330 L 315 330 L 315 410 L 230 410 Z',NY:'M 690 185 L 775 185 L 775 235 L 690 235 Z',
  NC:'M 640 330 L 740 330 L 740 365 L 640 365 Z',ND:'M 380 145 L 465 145 L 465 195 L 380 195 Z',
  OH:'M 615 250 L 660 250 L 660 305 L 615 305 Z',OK:'M 360 345 L 490 345 L 490 390 L 360 390 Z',
  OR:'M 115 175 L 200 175 L 200 245 L 115 245 Z',PA:'M 650 220 L 740 220 L 740 260 L 650 260 Z',
  RI:'M 795 220 L 810 220 L 810 235 L 795 235 Z',SC:'M 645 365 L 700 365 L 700 400 L 645 400 Z',
  SD:'M 380 195 L 465 195 L 465 255 L 380 255 Z',TN:'M 555 340 L 660 340 L 660 375 L 555 375 Z',
  TX:'M 320 360 L 500 360 L 500 470 L 380 490 L 320 440 Z',UT:'M 200 255 L 265 255 L 265 330 L 200 330 Z',
  VT:'M 775 170 L 795 170 L 795 210 L 775 210 Z',VA:'M 650 285 L 745 285 L 745 325 L 650 325 Z',
  WA:'M 115 130 L 200 130 L 200 180 L 115 180 Z',WV:'M 655 270 L 700 270 L 700 315 L 655 315 Z',
  WI:'M 520 185 L 565 185 L 565 255 L 520 255 Z',WY:'M 265 210 L 360 210 L 360 275 L 265 275 Z',
};

let stateRouting = null;

async function initMap() {
  if (!stateRouting) {
    const r = await fetch('/api/state-routing');
    stateRouting = await r.json();
  }
  renderMap('');
}

function getStateColor(state, payorId) {
  if (!payorId) return '#E2E8F0';
  const sn = stateRouting?.state_notes?.[state];
  const risks = stateRouting?.payor_state_risks?.[payorId];
  if (payorId === 'anthem_bcbs') {
    if (sn?.dnoa) return '#7c5cbf';
    if (risks?.high_risk_states?.includes(state)) return '#f39c12';
    return '#27ae60';
  }
  if (risks?.high_risk_states?.includes('ALL') || risks?.high_risk_states?.includes(state)) return '#e74c3c';
  return '#4f8ef7';
}

function renderMap(payorId) {
  const svg = document.getElementById('usSvg');
  svg.innerHTML = '';
  Object.entries(STATE_PATHS).forEach(([state, path]) => {
    const color = getStateColor(state, payorId);
    const el = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    el.setAttribute('d', path);
    el.setAttribute('fill', color);
    el.setAttribute('stroke', '#E2E8F0');
    el.setAttribute('stroke-width', '1.5');
    el.setAttribute('opacity', payorId ? '0.85' : '0.4');
    el.style.cursor = 'pointer';
    el.style.transition = 'opacity 0.15s';
    el.addEventListener('mouseenter', () => { el.setAttribute('opacity','1'); showStateDetail(state, payorId); });
    el.addEventListener('mouseleave', () => { el.setAttribute('opacity', payorId ? '0.85' : '0.4'); });
    // State label
    const bbox = path.match(/[-\d.]+/g).map(Number);
    const cx = (Math.min(...bbox.filter((_,i)=>i%2===0)) + Math.max(...bbox.filter((_,i)=>i%2===0))) / 2;
    const cy = (Math.min(...bbox.filter((_,i)=>i%2===1)) + Math.max(...bbox.filter((_,i)=>i%2===1))) / 2;
    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    text.setAttribute('x', cx); text.setAttribute('y', cy + 4);
    text.setAttribute('text-anchor', 'middle');
    text.setAttribute('font-size', '7'); text.setAttribute('fill', 'white');
    text.setAttribute('font-weight', '700'); text.setAttribute('pointer-events', 'none');
    text.textContent = state;
    svg.appendChild(el); svg.appendChild(text);
  });
}

function updateMap() {
  const payorId = document.getElementById('mapPayorSelect').value;
  renderMap(payorId);
  document.getElementById('mapStateDetail').innerHTML = `<div style="color:var(--text2);font-size:13px;text-align:center;padding:40px 0"><div style="font-size:32px;margin-bottom:8px">ğŸ‘†</div>Hover a state to see routing details</div>`;
}

function showStateDetail(state, payorId) {
  const sn = stateRouting?.state_notes?.[state] || {};
  const risks = stateRouting?.payor_state_risks?.[payorId] || {};
  const isHighRisk = risks.high_risk_states?.includes(state) || risks.high_risk_states?.includes('ALL');
  const isDNOA = sn.dnoa;
  const color = getStateColor(state, payorId);
  document.getElementById('mapStateDetail').innerHTML = `
    <div>
      <div style="font-size:22px;font-weight:800;margin-bottom:4px">${state}</div>
      <div style="font-size:12px;color:var(--text2);margin-bottom:16px">${sn.notes || 'Standard routing'}</div>
      ${isDNOA ? `<div style="background:rgba(124,92,191,0.15);border:1px solid rgba(124,92,191,0.3);border-radius:8px;padding:10px;font-size:12px;margin-bottom:10px">
        <strong style="color:#7C3AED">âŸ³ DNOA Routing</strong><br>BCBS in this state routes through DNOA (Dental Network of America), owned by HCSC. This is a completely different network path than other BCBS states.
      </div>` : ''}
      ${isHighRisk && !isDNOA ? `<div style="background:rgba(231,76,60,0.1);border:1px solid rgba(231,76,60,0.25);border-radius:8px;padding:10px;font-size:12px;margin-bottom:10px">
        <strong style="color:var(--red)">âš ï¸ High Risk State</strong><br>${risks.notes || 'Elevated silent PPO activity in this market.'}
      </div>` : ''}
      ${!isHighRisk && !isDNOA && payorId ? `<div style="background:rgba(39,174,96,0.1);border:1px solid rgba(39,174,96,0.25);border-radius:8px;padding:10px;font-size:12px">
        <strong style="color:var(--green)">âœ“ Standard Routing</strong><br>No special routing flags for this payor in ${state}.
      </div>` : ''}
      ${sn.bcbs_network ? `<div style="margin-top:10px;font-size:12px;color:var(--text2)">BCBS entity: ${sn.bcbs_network === 'dnoa' ? 'Routes via DNOA' : 'Direct BCBS entity'}</div>` : ''}
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CDT ALLOWABLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let cdtData = null;

async function loadCDT() {
  if (!cdtData) {
    const r = await fetch('/api/cdt');
    cdtData = await r.json();
  }
  renderCDT(cdtData.codes || []);
}

async function searchCDT() {
  const q   = document.getElementById('cdtSearch').value;
  const cat = document.getElementById('cdtCategory').value;
  const params = new URLSearchParams();
  if (q) params.set('q', q);
  if (cat) params.set('category', cat);
  const r = await fetch('/api/cdt?' + params);
  const data = await r.json();
  renderCDT(data.codes || []);
}

function renderCDT(codes) {
  const wrap = document.getElementById('cdtTableWrap');
  if (!codes.length) {
    wrap.innerHTML = `<div style="text-align:center;padding:40px;color:var(--text2)">No codes found</div>`;
    return;
  }
  const catColors = {Diagnostic:'#4f8ef7',Preventive:'#27ae60',Restorative:'#f39c12',Endodontics:'#e74c3c',Periodontics:'#9b59b6',
    'Oral Surgery':'#e67e22','Prosthodontics':'#1abc9c',Implants:'#3498db',Orthodontics:'#e91e63',Adjunctive:'#95a5a6'};

  wrap.innerHTML = `
    <div style="font-size:12px;color:var(--text2);margin-bottom:12px">${codes.length} codes Â· Ranges are typical allowables from public data sources</div>
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:14px;overflow:hidden">
    <table style="width:100%;border-collapse:collapse;font-size:13px">
      <thead>
        <tr style="border-bottom:1px solid var(--border)">
          <th style="padding:12px 16px;text-align:left;color:var(--text2);font-size:11px;text-transform:uppercase;letter-spacing:0.5px;font-weight:700">Code</th>
          <th style="padding:12px 16px;text-align:left;color:var(--text2);font-size:11px;text-transform:uppercase;letter-spacing:0.5px;font-weight:700">Description</th>
          <th style="padding:12px 16px;text-align:center;color:var(--text2);font-size:11px;text-transform:uppercase;letter-spacing:0.5px;font-weight:700">Medicaid</th>
          <th style="padding:12px 16px;text-align:center;color:var(--text2);font-size:11px;text-transform:uppercase;letter-spacing:0.5px;font-weight:700">Network PPO</th>
          <th style="padding:12px 16px;text-align:center;color:var(--text2);font-size:11px;text-transform:uppercase;letter-spacing:0.5px;font-weight:700">UCR Median</th>
          <th style="padding:12px 16px;text-align:center;color:var(--text2);font-size:11px;text-transform:uppercase;letter-spacing:0.5px;font-weight:700">UCR 90th</th>
        </tr>
      </thead>
      <tbody>
        ${codes.slice(0,200).map((c,i) => {
          const col = catColors[c.category] || '#888';
          const f = c.fees || {};
          return `<tr style="border-bottom:1px solid var(--border);${i%2===0?'':'background:var(--surface2)'}">
            <td style="padding:10px 16px"><span style="font-weight:800;color:var(--accent)">${c.code}</span><br><span style="font-size:10px;padding:1px 6px;border-radius:4px;background:${col}22;color:${col};margin-top:2px;display:inline-block">${c.category}</span></td>
            <td style="padding:10px 16px;color:var(--text);max-width:280px">${c.description}</td>
            <td style="padding:10px 16px;text-align:center;color:var(--text2)">${f.medicaid_low && f.medicaid_high ? `$${f.medicaid_low}â€“$${f.medicaid_high}` : 'â€”'}</td>
            <td style="padding:10px 16px;text-align:center"><span style="color:#4f8ef7;font-weight:600">${f.network_low && f.network_high ? `$${f.network_low}â€“$${f.network_high}` : f.network_median ? `$${f.network_median}` : 'â€”'}</span></td>
            <td style="padding:10px 16px;text-align:center;color:var(--green);font-weight:600">${f.ucr_median ? `$${f.ucr_median}` : 'â€”'}</td>
            <td style="padding:10px 16px;text-align:center;color:var(--yellow);font-weight:600">${f.ucr_90th ? `$${f.ucr_90th}` : 'â€”'}</td>
          </tr>`;
        }).join('')}
      </tbody>
    </table></div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ALERTS & NEWS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadAlerts() {
  const r    = await fetch('/api/news');
  const data = await r.json();

  const sevColor = {high:'var(--red)',medium:'var(--yellow)',low:'var(--green)'};
  const sevBg    = {high:'rgba(231,76,60,0.08)',medium:'rgba(243,156,18,0.08)',low:'rgba(39,174,96,0.08)'};
  const sevBorder= {high:'rgba(231,76,60,0.25)',medium:'rgba(243,156,18,0.25)',low:'rgba(39,174,96,0.25)'};

  document.getElementById('alertsList').innerHTML = (data.alerts || []).map(a => `
    <div style="background:${sevBg[a.severity]};border:1px solid ${sevBorder[a.severity]};border-radius:12px;padding:16px;margin-bottom:12px">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;gap:8px">
        <div style="font-size:14px;font-weight:700">${a.title}</div>
        <span style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:${sevColor[a.severity]};white-space:nowrap">${a.severity}</span>
      </div>
      <div style="font-size:12px;color:var(--text2);line-height:1.5;margin-bottom:10px">${a.body}</div>
      ${a.action_required ? `<div style="font-size:12px;background:var(--surface2);border-radius:6px;padding:8px 10px"><strong>Action Required:</strong> ${a.action}</div>` : ''}
      <div style="font-size:11px;color:var(--text2);margin-top:8px">${a.date} Â· Affects: ${(a.affected_payors||[]).join(', ')}</div>
    </div>`).join('') || '<div style="color:var(--text2);font-size:13px">No active alerts</div>';

  document.getElementById('newsList').innerHTML = data.articles?.length
    ? data.articles.map(a => `
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:12px">
        <div style="font-size:10px;text-transform:uppercase;letter-spacing:0.5px;color:var(--accent);margin-bottom:6px">${a.source}</div>
        <div style="font-size:14px;font-weight:600;margin-bottom:6px">${a.title}</div>
        <div style="font-size:12px;color:var(--text2);line-height:1.5">${a.summary}</div>
        <a href="${a.link}" target="_blank" style="font-size:12px;color:var(--accent);margin-top:8px;display:inline-block">Read more â†’</a>
      </div>`).join('')
    : `<div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:20px;text-align:center;color:var(--text2);font-size:13px">
        <div style="font-size:24px;margin-bottom:8px">ğŸ“¡</div>
        Live news feed connects to Becker's Dental, ADA News, ADSO and more.<br>Articles will appear here as they're published.
      </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UCR BENCHMARKING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let ucrData = null;

async function analyzeUCR() {
  const fileInput = document.getElementById('ucrFileInput');
  const target = parseInt(document.getElementById('ucrTarget').value);
  const btn = document.getElementById('ucrBtnText');
  
  if (!fileInput.files || !fileInput.files[0]) {
    alert('Please select a CSV file first');
    return;
  }
  
  btn.textContent = 'â³ Analyzing...';
  
  try {
    const file = fileInput.files[0];
    const text = await file.text();
    const rows = text.split('\n').map(r => r.trim()).filter(r => r);
    const headers = rows[0].toLowerCase().split(',');
    const codeIdx = headers.indexOf('code');
    const ucrIdx = headers.indexOf('ucr');
    const volIdx = headers.indexOf('volume');
    
    if (codeIdx === -1 || ucrIdx === -1) {
      alert('CSV must have columns: code, ucr (and optionally: volume)');
      btn.textContent = 'ğŸ“Š Analyze Fee Schedule';
      return;
    }
    
    const feeSchedule = [];
    for (let i = 1; i < rows.length; i++) {
      const cols = rows[i].split(',');
      if (cols.length <= codeIdx || cols.length <= ucrIdx) continue;
      const code = (cols[codeIdx] || '').trim().toUpperCase();
      const ucr = parseFloat((cols[ucrIdx] || '0').replace(/[$,]/g, ''));
      const volume = volIdx !== -1 && cols.length > volIdx 
        ? parseInt((cols[volIdx] || '0').replace(/,/g, '')) 
        : 0;
      if (code && ucr > 0) {
        feeSchedule.push({ code, ucr, volume });
      }
    }
    
    if (feeSchedule.length === 0) {
      alert('No valid codes found in CSV');
      btn.textContent = 'ğŸ“Š Analyze Fee Schedule';
      return;
    }
    
    const response = await fetch('/api/ucr/analyze', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ fee_schedule: feeSchedule, target_percentile: target })
    });
    
    const data = await response.json();
    ucrData = data;
    renderUCRResults(data);
    btn.textContent = 'ğŸ“Š Analyze Fee Schedule';
  } catch (err) {
    alert('Error analyzing file: ' + err.message);
    btn.textContent = 'ğŸ“Š Analyze Fee Schedule';
  }
}

async function loadSampleUCR() {
  const sampleSchedule = [
    { code: 'D0120', ucr: 52, volume: 5000 },
    { code: 'D0150', ucr: 89, volume: 1200 },
    { code: 'D1110', ucr: 95, volume: 3000 },
    { code: 'D2391', ucr: 178, volume: 800 },
    { code: 'D2392', ucr: 225, volume: 600 },
    { code: 'D2750', ucr: 950, volume: 200 },
    { code: 'D2740', ucr: 980, volume: 150 },
    { code: 'D3310', ucr: 720, volume: 80 },
    { code: 'D3330', ucr: 1050, volume: 60 },
    { code: 'D4341', ucr: 210, volume: 600 },
    { code: 'D4910', ucr: 138, volume: 1500 },
    { code: 'D7140', ucr: 172, volume: 300 },
    { code: 'D7210', ucr: 272, volume: 200 }
  ];
  
  const target = parseInt(document.getElementById('ucrTarget').value);
  const response = await fetch('/api/ucr/analyze', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ fee_schedule: sampleSchedule, target_percentile: target })
  });
  
  const data = await response.json();
  ucrData = data;
  renderUCRResults(data);
}

function renderUCRResults(data) {
  const { results, summary } = data;
  const statusColors = {
    'critically_low': { emoji: 'ğŸ”´', color: 'var(--red)', bg: 'var(--red-bg)', border: 'var(--red-border)' },
    'below_market': { emoji: 'ğŸŸ¡', color: 'var(--yellow)', bg: 'var(--yellow-bg)', border: 'var(--yellow-border)' },
    'at_market': { emoji: 'ğŸŸ¢', color: 'var(--green)', bg: 'var(--green-bg)', border: 'var(--green-border)' },
    'above_market': { emoji: 'ğŸ”µ', color: 'var(--accent)', bg: 'var(--accent-light)', border: '#BFDBFE' },
    'premium': { emoji: 'âšª', color: 'var(--text2)', bg: 'var(--surface2)', border: 'var(--border)' }
  };
  
  const healthScoreColor = summary.health_score >= 75 ? 'var(--green)' : summary.health_score >= 50 ? 'var(--yellow)' : 'var(--red)';
  
  document.getElementById('ucrResults').innerHTML = `
    <!-- UCR Health Score Card -->
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:24px;margin-bottom:20px;box-shadow:var(--shadow-sm)">
      <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:16px;margin-bottom:20px">
        <div>
          <h3 style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--text3);margin-bottom:8px;font-weight:700">UCR HEALTH SCORE</h3>
          <div style="font-size:48px;font-weight:800;color:${healthScoreColor}">${summary.health_score}<span style="font-size:24px;color:var(--text3)">/100</span></div>
        </div>
        <div style="flex:1;max-width:400px">
          <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text2);margin-bottom:6px">
            <span>ğŸ”´ ${summary.status_counts.critically_low}</span>
            <span>ğŸŸ¡ ${summary.status_counts.below_market}</span>
            <span>ğŸŸ¢ ${summary.status_counts.at_market}</span>
            <span>ğŸ”µ ${summary.status_counts.above_market}</span>
            <span>âšª ${summary.status_counts.premium}</span>
          </div>
          <div style="height:12px;background:var(--border);border-radius:6px;overflow:hidden;display:flex">
            ${summary.status_counts.critically_low > 0 ? `<div style="flex:${summary.status_counts.critically_low};background:var(--red)"></div>` : ''}
            ${summary.status_counts.below_market > 0 ? `<div style="flex:${summary.status_counts.below_market};background:var(--yellow)"></div>` : ''}
            ${summary.status_counts.at_market > 0 ? `<div style="flex:${summary.status_counts.at_market};background:var(--green)"></div>` : ''}
            ${summary.status_counts.above_market > 0 ? `<div style="flex:${summary.status_counts.above_market};background:var(--accent)"></div>` : ''}
            ${summary.status_counts.premium > 0 ? `<div style="flex:${summary.status_counts.premium};background:var(--text3)"></div>` : ''}
          </div>
        </div>
      </div>
      
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px">
        <div style="background:var(--surface2);border-radius:10px;padding:14px">
          <div style="font-size:11px;color:var(--text2);margin-bottom:4px">Codes Analyzed</div>
          <div style="font-size:24px;font-weight:700;color:var(--text)">${summary.total_codes}</div>
        </div>
        <div style="background:var(--surface2);border-radius:10px;padding:14px">
          <div style="font-size:11px;color:var(--text2);margin-bottom:4px">Annual Revenue Opportunity</div>
          <div style="font-size:24px;font-weight:700;color:var(--green)">$${summary.total_annual_impact.toLocaleString()}</div>
        </div>
        <div style="background:var(--surface2);border-radius:10px;padding:14px">
          <div style="font-size:11px;color:var(--text2);margin-bottom:4px">Target Benchmark</div>
          <div style="font-size:24px;font-weight:700;color:var(--accent)">${summary.target_percentile}th %ile</div>
        </div>
      </div>
    </div>
    
    <!-- Top Opportunities -->
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:24px;margin-bottom:20px;box-shadow:var(--shadow-sm)">
      <h3 style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--text3);margin-bottom:16px;font-weight:700">ğŸ¯ TOP OPPORTUNITIES (by Annual Revenue Impact)</h3>
      <div style="overflow-x:auto">
        <table style="width:100%;border-collapse:collapse;font-size:13px">
          <thead>
            <tr style="border-bottom:2px solid var(--border);background:var(--surface2)">
              <th style="padding:10px;text-align:left;color:var(--text2);font-size:11px;text-transform:uppercase">Status</th>
              <th style="padding:10px;text-align:left;color:var(--text2);font-size:11px;text-transform:uppercase">Code</th>
              <th style="padding:10px;text-align:left;color:var(--text2);font-size:11px;text-transform:uppercase">Description</th>
              <th style="padding:10px;text-align:right;color:var(--text2);font-size:11px;text-transform:uppercase">Current</th>
              <th style="padding:10px;text-align:right;color:var(--text2);font-size:11px;text-transform:uppercase">Suggested</th>
              <th style="padding:10px;text-align:right;color:var(--text2);font-size:11px;text-transform:uppercase">Gap</th>
              <th style="padding:10px;text-align:right;color:var(--text2);font-size:11px;text-transform:uppercase">Annual Impact</th>
            </tr>
          </thead>
          <tbody>
            ${results.slice(0, 20).map((r, i) => {
              const sc = statusColors[r.status];
              return `<tr style="border-bottom:1px solid var(--border);${i % 2 === 0 ? '' : 'background:var(--surface2)'}">
                <td style="padding:12px"><span style="font-size:18px">${sc.emoji}</span></td>
                <td style="padding:12px"><span style="font-weight:800;color:var(--accent)">${r.code}</span></td>
                <td style="padding:12px;color:var(--text);max-width:200px">${r.description}</td>
                <td style="padding:12px;text-align:right;color:var(--text)">$${r.current_ucr.toLocaleString()}</td>
                <td style="padding:12px;text-align:right;color:var(--green);font-weight:600">$${r.suggested_ucr.toLocaleString()}</td>
                <td style="padding:12px;text-align:right">
                  ${r.gap > 0 ? `<span style="color:var(--green);font-weight:600">+$${r.gap.toLocaleString()}</span><br><span style="font-size:11px;color:var(--text2)">(+${r.gap_pct}%)</span>` : '<span style="color:var(--text3)">â€”</span>'}
                </td>
                <td style="padding:12px;text-align:right;font-weight:700;color:${r.annual_impact > 0 ? 'var(--green)' : 'var(--text3)'}">
                  ${r.annual_impact > 0 ? '+$' + r.annual_impact.toLocaleString() : 'â€”'}
                </td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Export Actions -->
    <div style="display:flex;gap:12px;margin-top:20px">
      <button onclick="exportNewFeeSchedule()" style="background:var(--accent);color:white;border:none;border-radius:8px;padding:12px 24px;font-size:14px;font-weight:600;cursor:pointer;transition:all 0.2s">
        ğŸ“¥ Export New Fee Schedule (CSV)
      </button>
      <button onclick="exportExecutiveSummary()" style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:12px 24px;font-size:14px;font-weight:600;cursor:pointer;transition:all 0.2s">
        ğŸ“„ Export Executive Summary (PDF)
      </button>
    </div>
  `;
}

function exportNewFeeSchedule() {
  if (!ucrData || !ucrData.results) {
    alert('No analysis results available');
    return;
  }
  
  const results = ucrData.results;
  let csv = 'CDT Code,Description,Old UCR,New UCR,Change $,Change %,Benchmark Percentile,Status\n';
  
  results.forEach(r => {
    csv += `${r.code},"${r.description}",${r.current_ucr},${r.suggested_ucr},${r.gap},${r.gap_pct},${r.position_pct},${r.status}\n`;
  });
  
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `payormap-ucr-recommendations-${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  window.URL.revokeObjectURL(url);
}

function exportExecutiveSummary() {
  alert('PDF export coming soon! For now, use screenshot or print-to-PDF from your browser.');
}
</script>
</body>
</html>
